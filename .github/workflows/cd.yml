name: Continous Deployment

on:
  workflow_run:
    workflows: ["Continous Integration"]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Execute remote Git pull on VPS
      if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main' }}
      run: |
        echo "1/8: Setting up private key..."
        echo "${{ secrets.VPS_PRIVATE_KEY }}" > private_key
        chmod 600 private_key
        echo "2/8: Connecting to VPS and deploying changes..."
        echo "VPS_USERNAME: ${{ vars.VPS_USERNAME }}"
        echo "VPS_ADDRESS: ${{ vars.VPS_ADDRESS }}"
        ssh -i private_key -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null ${{ vars.VPS_USERNAME }}@${{ vars.VPS_ADDRESS }} "\
          echo '3/8: Changing directory to VPS_DIRECTORY...' && \
          echo 'VPS_DIRECTORY: ${{ vars.VPS_DIRECTORY }}' && \
          cd ${{ vars.VPS_DIRECTORY }} && \
          echo '4/8: Checking git initialization and setting up remote...' && \
          (test -d .git || git init) && \
          (git remote | grep -q '^origin$' || git remote add origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}github.com/${GITHUB_REPOSITORY}.git) && \
          echo '6/8: Fetching latest changes...' && \
          git fetch https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${GITHUB_REPOSITORY}.git && \
          echo '7/8: Resetting local branch to the exact commit...' && \
          echo 'github.sha: ${{ github.sha }}' && \
          git reset --hard ${{ github.sha }} && \
          git clean -f -d && \
          echo '8/8: Deployment complete!'"
        rm -f private_key
      env:
        PRIVATE_KEY: ${{ secrets.VPS_PRIVATE_KEY }}
